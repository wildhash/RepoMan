name: CI

on:
  push:
    branches: [main, "copilot/**"]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install ".[dev]"

      - name: Lint with ruff
        run: ruff check repoman tests

      - name: Check formatting
        run: ruff format --check repoman tests

      - name: Run unit tests
        run: pytest tests/unit -v --tb=short

  es-smoke:
    runs-on: ubuntu-latest

    # This job uses a dedicated Elasticsearch service container, so any indices it creates
    # are ephemeral to this job run.

    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.13.0
        env:
          discovery.type: single-node
          xpack.security.enabled: "false"
          xpack.security.http.ssl.enabled: "false"
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install ".[dev]"

      - name: Wait for Elasticsearch
        run: |
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:9200" >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Elasticsearch did not start" >&2
          exit 1

      - name: Setup indices
        env:
          REPOMAN_ELASTICSEARCH_URL: http://localhost:9200
          REPOMAN_EMBEDDING_PROVIDER: hash
          # CI uses tiny vectors for speed; the mappings are created with this dims value.
          REPOMAN_EMBEDDING_DIMS: "8"
        run: repoman es setup

      - name: Ingest + analyze a repo
        env:
          REPOMAN_ELASTICSEARCH_URL: http://localhost:9200
          REPOMAN_EMBEDDING_PROVIDER: hash
          # Uses the ephemeral Actions token and a public repo; for private org tests use a PAT secret instead.
          REPOMAN_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOMAN_EMBEDDING_DIMS: "8"
        run: repoman es ingest wildhash/RepoMan --issues-limit 5 --analyze
